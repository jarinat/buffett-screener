# AGENTS.md

Этот репозиторий ведется как AI-assisted проект. Любой агент, работающий в кодовой базе, обязан соблюдать правила ниже.

## 1. Продуктовый контекст

Продукт - личный исследовательский веб-инструмент для долгосрочного отбора компаний США по принципам Buffett / quality investing.

Это НЕ:
- day trading terminal;
- execution platform;
- robo-advisor;
- HFT / low-latency system;
- автотрейдинг в IBKR.

Главная ценность:
- прозрачные метрики,
- воспроизводимый расчет,
- понятные правила отбора,
- объяснимость результата по каждой компании.

Текущие зафиксированные решения v1:
- рынок покрытия: только США;
- режим использования: single-user private-only;
- auth subsystem в MVP не требуется;
- alerts в MVP: email;
- quality-first screener, без полноценного valuation layer;
- PE допустим как guardrail / reference metric.

## 2. Неприкосновенные архитектурные правила

1. Никогда не пришивать бизнес-логику к одному провайдеру данных.
2. Никогда не считать итоговый score только на фронтенде.
3. Любая формула метрики должна жить в одном месте и иметь версию.
4. Любое изменение правил отбора должно сопровождаться обновлением документации.
5. Сырые данные, нормализованные данные и производные метрики должны быть разделены.
6. Нельзя удалять исторические результаты screen runs без явного решения.
7. Нельзя внедрять торговые функции в MVP без отдельного ADR-решения.

## 3. Приоритеты при реализации

При конфликте выбирай в таком порядке:

1. корректность финансовых расчетов;
2. воспроизводимость результата;
3. простота сопровождения;
4. наблюдаемость и дебаг;
5. удобство UI;
6. производительность сверх разумного.

## 4. Правила изменения доменной модели

При добавлении новой метрики необходимо:

1. описать бизнес-смысл метрики;
2. указать формулу;
3. определить required input fields;
4. определить периодичность расчета;
5. описать обработку missing / malformed data;
6. указать версию правила;
7. добавить unit tests;
8. обновить `docs/05_DATA_AND_METRICS.md`.

## 5. Правила работы с провайдерами данных

### Обязательно

- использовать adapter interface;
- логировать источник каждого набора данных;
- хранить timestamp загрузки;
- хранить признак успешной / частичной / неуспешной загрузки;
- уметь повторно запускать ingestion идемпотентно.

### Запрещено

- смешивать raw payload и normalized model в одной таблице;
- silently исправлять данные без trace;
- рассчитывать долгосрочные метрики только по одному году;
- считать отсутствие поля равным нулю без явного правила.

## 6. Правила для AI-агента по кодингу

Перед изменением кода агент обязан определить, к какому слою относится задача:

- provider adapter
- ingestion
- normalization
- metrics engine
- screening engine
- alert engine
- API
- frontend
- infra
- docs

Если задача затрагивает 2+ слоя, агент должен:
- разделить изменения по файлам и ответственности,
- описать риск места,
- обновить документацию.

## 7. Definition of Done для любой задачи

Задача не считается законченной, пока не выполнено все:

- код компилируется / запускается;
- тесты проходят;
- документация обновлена, если затронута доменная логика;
- нет жёсткой привязки к Yahoo;
- нет дублирования формул в нескольких местах;
- есть понятное объяснение, как проверить результат руками.

## 8. Что агенту делать в сомнительных случаях

Если правило инвестирования неочевидно:
- не выдумывать "канонический Buffett";
- помечать это как пользовательское правило проекта;
- выносить в конфиг или rule definition;
- фиксировать допущение в docs.

Если источник данных не дает нужной глубины:
- не занижать silently требование;
- пометить metric status = insufficient_data;
- предложить fallback provider path.
