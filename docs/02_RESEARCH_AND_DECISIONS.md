# 02. Research and Decisions

## 1. Исходный вопрос

Подходит ли `yfinance` / Yahoo Finance как стартовый источник данных для личного Buffett-style screener, и какой стек выбрать для устойчивого развития проекта.

## 2. Краткий вывод

### Вердикт

**Да, `yfinance` подходит как стартовый источник для personal-use MVP, но не должен быть единственным архитектурным основанием системы.**

Причина:
- стартовать быстро можно;
- Python-экосистема удобна;
- исторические цены, часть фундаментальных данных и базовый скрининг есть;
- но есть ограничения по юридическому режиму использования, устойчивости, rate limiting и глубине фундаментальной истории.

## 3. Что дает `yfinance`

Из плюсов:

- Python-friendly API;
- загрузка цен и корпоративных действий;
- доступ к части фундаментальных данных;
- готовые механизмы `Ticker`, `download`, `Search`, `screen`, `EquityQuery`;
- можно быстро поднять MVP без покупки дорогого провайдера.

## 4. Ограничения `yfinance`, важные именно для этого проекта

### 4.1. Это не официальный коммерческий data provider

`yfinance` прямо указывает, что:
- не аффилирован с Yahoo;
- использует публично доступные Yahoo endpoints;
- предназначен для research / educational use;
- Yahoo Finance API intended for personal use only.

Для личного приватного инструмента это еще можно принять.
Для командного продукта, SaaS или коммерческого сервиса - уже риск.

### 4.2. Фундаментальная история может быть недостаточной

Для твоего случая это критично, потому что часть правил требует:
- рост выручки за 10 лет;
- рост чистой прибыли за 10 лет;
- устойчивость серии без больших провалов.

Проблема:
- в экосистеме Yahoo / yfinance регулярно всплывает вопрос, как получить больше нескольких лет исторических financial statements;
- сам Yahoo в help-материалах рекламирует на free plan до 5 лет financials.

Вывод:
- на одном Yahoo строить 10-year rule-set опасно;
- длинные метрики должны считатьcя поверх абстракции provider, чтобы позже можно было подключить другой источник.

### 4.3. Возможны rate limits и нестабильность

Для batch-загрузок и периодического обновления universe это неприятно, но терпимо.
Для production-grade зависимости как единственного источника - плохо.

Следствие:
- ingestion должен быть с retry / backoff / partial-failure handling;
- нужно хранить статус загрузки и не считать пустой ответ нормой.

## 5. Вывод по Yahoo / yfinance

### Решение D-001
Использовать `yfinance` как **Provider A** для MVP.

### Ограничения решения
- режим использования: personal-only;
- MVP должен уметь жить при неполных financials;
- 10-year metrics не считать "абсолютно надежными" без fallback provider.

### Защитное архитектурное решение
Сразу заложить provider adapter interface:

- `CompanyUniverseProvider`
- `MarketDataProvider`
- `FundamentalsProvider`
- `PortfolioSyncProvider` (future)

## 6. Нужен ли встроенный screener от Yahoo

### Ответ
Частично полезен, но недостаточен.

Почему:
- встроенный `yfinance.screen` хорош для coarse pre-filter;
- пользовательские Buffett-метрики у тебя считаются не по готовым Yahoo полям, а по собственным правилам;
- значит финальный screening engine должен быть свой.

### Решение D-002
Использовать Yahoo screener только как вспомогательный источник universe / pre-filter, но не как основной движок правил.

## 7. Что делать с 10-летними метриками

### Решение D-003
Проектировать метрики так, чтобы они:
- рассчитывались на основании хранимых серий;
- явно помечались статусом достаточности данных;
- не ломали весь screen при отсутствии нужной глубины.

### Результат
Для каждой long-horizon metric должны быть поля:

- `value`
- `status`
- `coverage_years`
- `rule_version`
- `calculated_at`

Пример статусов:
- `ok`
- `insufficient_data`
- `provider_gap`
- `calculation_error`

## 8. Выбор backend stack

### Почему backend - Python
У проекта сильная зависимость от:
- табличных финансовых данных;
- агрегаций;
- вычислений по временным рядам;
- batch-задач;
- гибкой доменной логики.

Python для этого естественнее и дешевле в развитии, чем переносить ядро в TypeScript.

### Решение D-004
Backend:
- FastAPI
- SQLAlchemy / SQLModel layer
- PostgreSQL
- Alembic
- APScheduler for recurring jobs
- email provider API for alerts

## 9. Выбор frontend stack

### Требования фронта
- удобная таблица со множеством фильтров;
- сохраненные представления;
- карточка компании;
- простые формы управления screen / alerts;
- комфортная работа в браузере.

### Решение D-005
Frontend:
- Next.js
- TypeScript
- Tailwind CSS
- table/grid library for rich filtering and sorting

Причина:
- зрелая экосистема;
- хороший DX;
- удобно развивать веб-интерфейс независимо от Python backend;
- хорошо сочетается с AI-assisted разработкой.

## 10. Нужен ли Redis / queue на старте

Для твоего режима использования:
- пользователь один;
- обновления не поминутные;
- инвестирование редкое;
- alerts не высокочастотные.

### Решение D-006
В MVP **не тащить Redis / Celery / отдельную очередь**, пока нет реальной нагрузки.

Старт:
- APScheduler + DB state + идемпотентные jobs.

Условие эскалации:
если появятся долгие массовые пересчеты, multi-user или тяжелые job chains, тогда перейти на отдельный worker stack.

## 11. Email alerts

Для первой версии важнее надежно отправить письмо, чем строить сложную notification platform.

### Решение D-007
На первом этапе:
- email alerts;
- event log;
- deduplication logic;
- digest mode позже.

Другие каналы (Telegram, push) - после стабилизации доменной модели.

## 12. Интеграция с IBKR

С учетом текущей цели, приложение не обязано торговать.
Но read-only синхронизация портфеля позже будет полезна:
- видеть текущие holdings;
- проверять, есть ли кандидат уже в портфеле;
- отслеживать размер позиции;
- строить watchlist относительно holdings.

### Решение D-008
IBKR интеграцию отложить до фазы 2 и начинать только с read-only:
- Flex Web Service для отчетов / history;
или
- Client Portal Web API для account / positions / portfolio data.

## 13. Рекомендованный fallback provider path

### Решение D-009
Сразу предусмотреть второй провайдер фундаментальных данных.

Приоритет на будущее:
1. FMP / Financial Modeling Prep - как pragmatic replacement для financial statements и growth endpoints;
2. Alpha Vantage - как запасной официальный API-источник;
3. другие платные провайдеры - если проект перерастет personal-use режим.

## 14. Главная стратегическая мысль

Суть проекта не в том, чтобы "подключить Yahoo".
Суть проекта - создать собственный **screening core**, в который Yahoo сейчас лишь подает данные.

Если это ядро будет хорошим, источник можно заменить.
Если ядро завязать на один источник, проект станет хрупким.


## 15. Зафиксированные product decisions после уточнения scope

### Решение D-010
Universe v1 ограничивается компаниями США.

Причина:
- выше предсказуемость coverage у Yahoo / альтернативных провайдеров;
- проще нормализовать отчетность и сравнивать компании между собой;
- ниже риск провалов в 10-year metrics.

### Решение D-011
MVP работает в single-user режиме без auth subsystem.

Причина:
- пользователь один;
- приложение private-only;
- auth в этой фазе не создает основной ценности.

Следствие:
- settings и saved screens можно моделировать без multi-tenant абстракций.

### Решение D-012
Канал оповещений v1 - только email.

Причина:
- этого достаточно для режима пересмотра раз в квартал / полгода;
- Telegram / push не нужны для MVP.

### Решение D-013
В стартовый набор метрик добавляются ROE и PE.

Методологическая оговорка:
- ROE - quality / capital efficiency metric;
- PE - valuation-adjacent metric.

Интерпретация для v1:
- продукт остается quality-first screener;
- PE используется как дополнительный reference metric или optional hard guardrail;
- полноценный valuation layer не строится.
